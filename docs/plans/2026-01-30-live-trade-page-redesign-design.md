# 实盘交易页面重规划设计文档

## 背景与目标
实盘交易页承担“连接、下单、监控、健康检查”的核心职责，但现有页面模块间定义模糊、刷新频繁且来源不一致，导致用户对“数据是否可信”“状态是否同步”缺乏明确预期。本设计目标是在不引入新功能的前提下，明确功能边界、统一数据来源、降低刷新噪音，并形成可扩展的页面架构，为后续实现留出清晰路径。

## 现状问题摘要
- **模块职责重叠**：连接状态、市场快照、行情流、监控区同时展示相似信息，但定义不一致。
- **刷新策略不统一**：多处轮询（5s/10s/60s）叠加，导致视觉闪烁与状态跳变。
- **监控数据来源混杂**：订单/成交回执与 UI “实盘监控”关系不清晰。
- **关键任务分散**：项目绑定、训练模型、执行器状态、持仓/账户各自分布，缺乏主流程引导。

## 设计原则
1. **任务流驱动**：按“连接 → 项目绑定 → 账户 → 持仓 → 下单 → 监控”组织页面。
2. **主次分层**：主页面只保留高频、高价值、强决策相关模块；其余归入“高级/详情”。
3. **单一事实源**：所有 IB/TWS 信息统一来自 Lean Bridge，避免直连 IB API。
4. **低噪声刷新**：分区刷新 + 明确更新时间提示，避免全页频繁刷新。
5. **可观测与可解释**：每块明确数据来源、更新时间、错误原因与恢复建议。

## 信息架构（主页面/高级页面）
### 主页面（默认）
- 连接状态（Lean Bridge）
- 账户概览（Account Summary）
- 当前持仓（Positions）
- 下单执行（当前持仓买卖）
- 实盘监控（Orders 默认 Tab）

### 高级/详情
- 合约刷新（Contracts）
- 行情源健康（整合原“市场快照/行情流”）
- 历史任务/回测记录（History Jobs）
- 执行器/守护状态（Execution/Guard）
- 配置管理（Config）

## 模块定义与边界
### 1) 连接状态（Lean Bridge）
- 展示：Bridge 在线、最近心跳、最后同步时间、客户端 ID 状态。
- 操作：重连/刷新；出现异常时提示“重启 Bridge”或“检查 TWS”。
- 数据来源：Bridge status API。

### 2) 项目绑定与决策快照
- 仅保留在“项目绑定”模块内部展示“当前策略/模型/参数”快照。
- 不在全局概览重复展示，避免信息冲突。

### 3) 账户概览
- 展示净资产、可用现金、保证金等关键字段。
- 与持仓/监控一致以 Bridge 数据为准。

### 4) 当前持仓
- 标准列表（标的、数量、均价、市值、盈亏）。
- 支持单条“买入/卖出”触发，走 Lean 执行器。
- 附带数据更新时间与“刷新”按钮。

### 5) 下单执行
- 入口在“当前持仓”内完成，统一形成订单记录与回执流。
- 明确 UI 文案：下单 -> 订单提交 -> 回执/成交状态变更。

### 6) 实盘监控
- Tab：默认 Orders；可切换 Fills / Receipts。
- 数据源只来自 Lean 回执，展示客户端 ID、订单状态、成交回报。
- 明确：监控区展示“订单提交/成交回执”。

### 7) 行情源健康（整合）
- 主页面仅展示一个状态胶囊（正常/延迟/离线）。
- 详情页可展开展示具体行情源、最后更新时间、延迟指标。

## 刷新策略
- 连接状态/行情健康：10s
- 实盘监控：15s
- 账户概览/持仓：60s
- 手动刷新按钮：立即拉取指定模块
- 任何刷新均显示“最后更新时间”

## 数据流与一致性
- **唯一来源**：IB 相关数据一律来自 Lean Bridge。
- **写入路径**：下单 -> Lean 执行器 -> IB -> 回执 -> Bridge -> 后端/前端。
- **一致性提示**：当 Bridge 离线时，所有依赖模块显示“数据过期”。

## 失败与恢复策略
- Bridge 掉线：所有模块显示过期提示 + 重连引导。
- IB/TWS 重启：触发 Bridge 健康检测，自动提示“重启 Bridge”或“等待重连”。
- 回执缺失：监控区提示“无回执/等待中”，并附带刷新时间戳。

## 可观测性
- 关键 API 返回包含：`source`, `last_updated_at`, `status`。
- 前端统一显示时间戳与状态标签。

## 验证与测试
- 手动测试路径：连接状态 → 持仓刷新 → 账户刷新 → 下单 → 回执显示。
- 重点测试：TWS 重启后 Bridge 恢复、持仓恢复一致性、回执同步。

## 里程碑建议
1. 页面信息架构调整（UI 重排 + 模块归并）
2. 刷新策略统一与时间戳展示
3. 监控区回执统一与“订单/成交”对齐
4. Bridge 健康提示与恢复指引

