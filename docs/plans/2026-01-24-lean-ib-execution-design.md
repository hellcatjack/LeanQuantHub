# Lean IB 执行接入设计（逻辑一致版）

> 目标：在**保留现有 Alpha 研究/回测逻辑**的前提下，引入 **Lean + IB Brokerage** 执行器，实现**逻辑一致**的实盘/模拟盘交易闭环；接受成交价格差异，并建立可解释对账机制。

---

## 1. 背景与约束
- 研究/回测依赖 Alpha 数据（PIT 需求），IB 数据无法满足 PIT 训练/回测。
- 当前回测已通过 Lean Runner 运行，但执行仍为自建 IB 逻辑。
- 目标“全栈一致”定义为：**算法逻辑一致 + 风控一致 + 订单语义一致 + 对账可解释**。

---

## 2. 现状评估
- **已使用 Lean**：回测（`lean_runner`）、算法脚本（`algorithms/`）。
- **未使用 Lean**：实盘/模拟盘执行（`trade_executor` + `ib_*`）。
- **差异来源**：
  - 研究/回测使用 Alpha（复权）
  - 执行价格来自 IB 成交

---

## 3. 设计目标
1) 保留 Alpha 研究/回测闭环不变。
2) 引入 Lean IB Brokerage 作为执行通道。
3) 执行端回写订单/成交状态到现有交易表。
4) 形成“回测 vs 实盘差异”的可解释报告。

---

## 4. 关键对齐点
### 4.1 信号输出与执行输入对齐
- 标准化“订单意图”文件（CSV/JSON）：
  - `symbol, weight, side, target_value, snapshot_date, rebalance_date, order_type, limit_price`
- Lean 执行器读取订单意图并下单。

### 4.2 订单语义对齐
- TradeOrder ↔ Lean OrderTicket 映射：
  - 订单类型（MKT/LMT）
  - TIF、最小手数、交易时间
- Lean OrderEvent 回写到 `trade_orders` / `trade_fills`。

### 4.3 风控逻辑对齐
- 风控参数统一来源：`TradeSettings.risk_defaults` + `risk_overrides`
- 执行前必须再次验证风控，阻断要可审计。

### 4.4 价格偏差解释机制
- 记录成交价与成交时间
- 对比回测信号价，输出偏差明细
- UI 展示偏差原因（滑点/交易时间差异等）

---

## 5. 执行架构
### 5.1 Lean Execution Provider
- 独立执行模块：
  - 读取订单意图
  - 走 IB Brokerage 下单
  - 回写订单与成交

### 5.2 研究/回测保持现有逻辑
- Alpha 数据继续提供 PIT 支持
- Lean Runner 回测继续使用已有逻辑

---

## 6. 分阶段计划
### Phase 1（MVP 执行闭环）
- 订单意图标准化输出
- Lean 执行器接入 IB Brokerage
- 回写订单与成交状态
- 可执行最小闭环

### Phase 2（执行一致性增强）
- 对账报告：回测价 vs 实盘价
- 持仓/资金以 IB 回报为准
- UI 展示执行偏差

### Phase 3（稳健性与可运维）
- 执行异常告警
- 自动重试与降级
- 完整审计日志

---

## 7. 验收标准（逻辑一致版）
- 同一决策快照在回测与实盘执行中使用相同信号逻辑。
- 订单生命周期在 UI 与数据库中可追溯。
- 风控规则与执行结果可解释。
- 回测与实盘差异可解释且可审计。

---

## 8. 风险与缓解
- **价格差异**：通过对账报告与解释机制缓解。
- **执行失败**：Lean/IB 执行器加入重试与告警。
- **口径漂移**：统一风控与订单语义。

---

## 9. 下一步
- 进入实施计划阶段（拆分任务、工期与依赖）。
- 更新 `docs/todolists/IBAutoTradeTODO.md` 对齐任务清单。
