# 实盘交易持仓动作与批量平仓设计

## 目标
- 在实盘交易页面的“当前持仓”中新增：买入/卖出/平仓动作、批量平仓、全仓清空。
- 与 Lean IB Bridge 订单回写对齐，确保订单状态与成交信息可追踪。
- 全链路使用全局唯一 tag，避免并发与重放冲突。

## 范围
- 仅限前端交互与订单请求/回写展示层；不改变核心交易逻辑。
- 订单执行通道沿用现有 Lean IB Bridge。
- 不引入新依赖。

## 交互设计
- 持仓表新增“操作”列：买入 / 卖出 / 平仓（平该标的全部仓位）。
- 表头上方新增“批量操作栏”：显示勾选数量、批量平仓按钮、全仓清空按钮。
- 批量平仓=仅勾选持仓；全仓清空=所有持仓。
- 批量平仓与全仓清空均需要二次确认（明确提示“市价清仓/可能滑点”）。
- 行内买/卖默认预填 symbol/account/currency，数量由用户输入。
- 风险按钮使用危险样式并附警示文案。

## 数据流与订单回写
- 每个动作生成全局唯一 tag：`oi_{trade_run_id}_{index}_{epoch_ms}_{rand4}`。
- tag 进入下单 payload，并在 `execution_events.jsonl` 回写中返回。
- 订单状态在 UI 的订单/成交列表中展示，并可按 tag 精确匹配。
- 批量平仓拆为多条订单，每条订单持有独立 tag。

## 风控与错误处理
- 二次确认弹窗展示：标的数量、预计清仓方向、提示风险。
- 若回写超时未匹配到 tag，展示“回写延迟”提示并提供刷新。
- 若返回失败状态，展示失败原因并保留重试入口。

## 全局唯一 tag 保障
- `epoch_ms + rand4` 组合确保同一 trade_run 下多次下单不冲突。
- UI 与后端均只以 tag 作为回写关联依据（不依赖 ib_order_id 作为唯一主键）。

## 测试计划（概要）
- Playwright：
  - 单标的平仓：验证订单生成与状态回写渲染。
  - 批量平仓（2 支以上）：验证二次确认与拆单。
  - 全仓清空：验证全选与风险确认。
- 单元/轻量测试：
  - tag 生成唯一性规则验证。

## 非目标
- 不调整后端交易撮合逻辑或 IB 配置。
- 不修改回测/数据源流程。
