# 实盘交易 UI 全流程（含 Playwright 验证）设计

## 目标与范围
本设计目标是将“周度检查 → 当日模型决策 → Paper 实盘执行 → 结果复核”的完整 workflow 固化为可重复、可自动验证的 UI 流程，并通过 Playwright 在无登录场景下稳定跑通。该流程以项目 16 为基准，运行环境为 `http://192.168.1.31:8081`。范围包含：前端 UI 操作路径明确化、必要的 UI 元素标准化（data-testid 或可稳定定位的文本/角色）、端到端验证脚本，以及对异常路径的可观测性要求（状态提示、可见错误信息）。

## UI 流程与页面角色
UI 流程分为四段：
1) 数据页 → PreTrade 周度检查：发起周度检查并验证“完成/通过”状态可视。该页应提供明确的检查按钮与状态标签。
2) 项目页 → 算法 → 当日模型决策：生成当日决策快照并确认“今日快照”出现（时间戳更新）。
3) 实盘交易页（侧边栏）→ Paper 执行：选择项目 16，发起 Paper 交易（创建 trade_run 并执行），观察状态从 queued → running/blocked/done。
4) 实盘交易页结果复核：订单列表与持仓列表刷新，可见当前执行结果或阻断原因。

## 关键选择器与稳定性策略
优先为关键按钮和状态元素添加 data-testid，以规避文案变更带来的脚本脆弱性。若无法添加，采用 Playwright 的 `getByRole` + 可读文本兜底。关键节点包括：周度检查按钮/状态标签、当日模型决策按钮/快照列表、实盘交易执行按钮/状态标签、订单/持仓表格容器。对数据加载与状态变化采用“条件等待”策略（等待状态文本出现或表格行数变化），避免固定 sleep。

## 数据流与异常处理
E2E 流程依赖三类后端状态：PreTrade 检查状态、Decision Snapshot 列表、TradeRun 状态。前端需在 UI 中可见显示“失败原因/阻断原因”（如 bridge_unavailable、risk_blocked）。Playwright 脚本在遇到阻断状态时应记录截图与日志，并终止后续步骤，保证失败原因可追溯。

## 测试与验证策略
Playwright 脚本作为唯一验收标准，覆盖主干路径：周度检查成功 → 当日决策生成 → Paper 下单执行 → 结果可见。失败路径最少覆盖 1 条：bridge_unavailable 时应在 UI 中显示阻断原因并被脚本捕获。执行测试前需确保 TWS/IB Bridge 可用；测试运行完成后保留截图与 trace（若开启）。
