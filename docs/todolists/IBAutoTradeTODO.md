# IB 自动化交易闭环 TODO（首期）

本文件定义将系统扩展为**全自动模拟盘/实盘交易**的详细设计与落地任务。首期目标：**IB PRO 账户 + IB 数据源 + 周频调仓闭环**，参考 QuantConnect/Lean 架构。

## 目标与范围
- 目标：从数据→信号→风控→执行→监控形成可追溯闭环，可在 Paper/Live 切换。
- 交易账户：IB PRO（优先 Paper，再 Live）。
- 数据源：实盘/模拟盘**交易所需数据统一来自 IB**（行情/合约/历史补齐）。
- 周期：周一开盘调仓（与现有 PreTrade checklist 对齐）。

## 菜单与入口（对齐最新主菜单布局）
> 最新主菜单：项目 → 数据 → 回测&报告 → 主题库 → 系统审计  
> 实盘交易需新增一级入口并与上述布局融合。

- 主菜单新增“实盘交易”（建议路径：`/live-trade` 或 `/trade`）。
- 推荐顺序：项目 → 数据 → 回测&报告 → **实盘交易** → 主题库 → 系统审计。
- 未配置 IB 时：入口可见但标记“未配置/只读”，避免误操作。
- 项目页顶部提供“实盘交易”快捷入口（非必须，但建议），便于从项目直接跳转执行面板。

### 菜单验收
- 主菜单中“实盘交易”可见且不与回测/报告混淆。
- 入口状态清晰：未配置/未连接/可交易。

## 非目标
- 首期不覆盖期权交易（Phase 7 以后）。
- 首期不强制覆盖分钟级高频策略。
- 首期不替换现有训练数据源（训练/回测仍以 Alpha 为主，交易执行用 IB）。

## 关键设计原则
- **单实例执行**：同一服务器多副本启动时，严禁并发下单。
- **幂等与可回溯**：订单、信号、回测参数必须可追溯并可复现。
- **数据与执行一致**：实盘/模拟执行必须使用 IB 数据，避免行情与成交源不一致。
- **风险优先**：任何风控触发都应阻止下单并告警。

## 术语/模块映射（对齐 QC/Lean）
- DataFeed → IB 行情/历史数据
- Universe → 项目主题/系统主题
- Alpha → ML 评分与决策快照
- Portfolio Construction → 权重生成 + 约束
- Execution → IB 下单与订单状态机
- Risk → 风控与熔断
- Brokerage → IB Gateway/TWS

---

## Phase 0：基础设施与连通（必做）
### 0.1 IB 连接管理
- [ ] IB Gateway/TWS 常驻服务（systemd 用户服务），支持自动重连。
- [x] 连接健康检测与状态展示（UI/接口）。
- [ ] Paper/Live 开关：UI 可配置，默认 Paper。
- 验收：断线 60 秒内可恢复，状态可查询。

### 0.2 交易配置管理（配置与安全）
- [ ] 后端配置项：IB_HOST、IB_PORT、IB_CLIENT_ID、IB_ACCOUNT、IB_MODE。
- [ ] UI 配置时**不明文显示**敏感字段（只展示掩码）。
- 验收：配置保存后能成功建立连接。

### 0.3 单实例交易锁
- [ ] 复用现有 TradeTODO 的锁/心跳逻辑，加入 IB 交易流程前置校验。
- [ ] 多副本同时启动时只允许一个实例“执行交易”。
- 验收：并发启动只允许一个实例进入执行态。

---

## Phase 1：IB 数据接入（必做）
### 1.1 合约主数据缓存
- [ ] symbol → IB conId 缓存（交易所、货币、乘数）。
- [ ] 允许刷新合约缓存（增量为主）。
- 验收：项目主题标的全部可解析 conId。

### 1.2 实时行情订阅
- [x] IB L1 订阅（bid/ask/last/volume）。
- [x] 行情缓存落地到 `data/ib/stream/`（或统一 data_root/ib）。
- [x] 订阅速率与连接状态监控。
- 验收：UI/日志可查看实时行情刷新。

### 1.3 历史数据补齐（最小化）
- [x] IB historical 用于最近窗口补齐（日线/分钟线）。
- [x] 控速、断点续跑、幂等写入。
- [x] 验收：指定周期内数据完整率可审计。

### 1.4 数据源策略
- [x] 实盘/模拟盘数据源固定为 IB。
- [x] 明确“交易信号用 IB 数据”与“训练用 Alpha 数据”的边界。
- 验收：实盘交易不依赖 Alpha 行情。

---

## Phase 2：订单与执行（必做）
### 2.1 订单状态机
- [x] NEW → SUBMITTED → PARTIAL → FILLED/CANCELED/REJECTED。
- [x] clientOrderId 幂等（重试不重复下单）。
- [x] 成交回报回写 DB。
- 验收：重复触发不会产生重复订单。

### 2.2 订单拆分与下单规则
- [x] 权重 → 目标市值 → 股数计算（整数、最小交易单位）。
- [x] 价格来源：IB 实时/近实时。
- [x] 订单类型：首期支持 MKT 与 LMT（默认 MKT）。
- 验收：输入权重能生成合法订单。

---

## Phase 3：风控与回退（必做）
### 3.1 预交易风控
- [ ] 可用资金/保证金/最大仓位/单票上限/行业上限。
- [ ] 未通过时阻止下单并报警。
- 验收：风控触发后无下单行为。

### 3.2 盘中风险管理
- [ ] 单日亏损阈值、最大回撤阈值。
- [ ] 触发后自动停机、回滚或进入防御资产。
- 验收：触发后系统进入保护状态。

### 3.3 回退机制
- [ ] 下单失败/行情异常时回退至上次成功模型/权重。
- [ ] UI 展示“回退目标版本”。
- 验收：回退有审计记录。

---

## Phase 4：模型决策联动（必做）
### 4.1 当日决策快照冻结
- [ ] 生成当日决策快照：模型版本 + 评分 + 权重 + 参数。
- [ ] 交易执行只读此快照。
- 验收：回测/实盘信号一致可追溯。

### 4.2 交易与回测参数一致性
- [ ] 交易执行记录回测参数/策略参数版本。
- 验收：回测可复现对应交易日行为。

---

## Phase 5：监控与告警（必做）
- [ ] 账户/持仓/订单/PNL 实时监控面板。
  - [x] 实盘交易页展示账户摘要与持仓明细。
  - [ ] 订单/PNL 统一监控面板补全与汇总指标。
- [ ] Telegram 告警：断线、下单失败、风控触发。
- [ ] 告警去重与抑制（避免刷屏）。
- 验收：关键事件可被及时通知。

---

## Phase 6：自动化调度（必做）
- [ ] 周度调仓调度器：PreTrade checklist → 决策冻结 → 下单 → 盘后审计。
- [ ] 任务幂等，重复触发不会重复下单。
- [ ] 失败重试与超时策略与 UI 配置。
- 验收：可一键执行完整流程。

---

## Phase 7：期权扩展（后续）
- [ ] 期权合约链、期权行情、Greeks/IV。
- [ ] 期权风控（保证金、行权/指派处理）。
- [ ] 期权对冲策略配置与回测支持。

---

## 数据与存储设计（建议）
- `data/ib/`  
  - `contracts/` 合约缓存  
  - `stream/` 实时行情  
  - `bars/` 历史补齐  
  - `orders/` 订单流水快照（可选）
- DB 表建议（如需新增）：
  - `ib_connection_state`
  - `ib_contract_cache`
  - `trade_orders`
  - `trade_fills`
  - `trade_runs`（每日执行批次）

---

## UI/UX 设计要点
- 交易状态清晰：连接状态、数据源、账户模式（Paper/Live）。
- 执行按钮必须二次确认（Live）。
- 订单与持仓展示不与回测混淆，突出“实盘信号版本”。

### UI/UX 落地状态
- [x] 订单明细与成交明细视图（Orders/Fills）。
- [x] 目标权重 vs 成交偏离对比表。

---

## 关键验收标准
1) Paper 模式：周度调仓可自动执行，且订单与成交完整可追溯。
2) 风控触发：能阻止下单并告警。
3) 数据一致：交易行情与执行来源一致（IB）。
4) 单实例锁：多副本启动不重复下单。
